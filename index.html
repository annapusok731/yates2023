<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Comparison Study</title>
    
    <!-- jsPsych CSS -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <!-- jsPsych Scripts -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    
    <style>
        .jspsych-btn {
            margin: 10px;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .consent-content {
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px auto;
            max-width: 800px;
        }
        
        .consent-checkboxes {
            text-align: left;
            max-width: 600px;
            margin: 20px auto;
        }
        
        .consent-checkboxes label {
            display: block;
            margin: 10px 0;
        }
        
        .face-images {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 5vw;
            margin: 30px 0;
            height: 40vh;
        }
        
        .face-images img {
            width: 35vw;
            max-width: 500px;
            height: 40vh;
            object-fit: contain;
            border-radius: 12px;
        }
        
        .trial-question {
            color: #333;
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .choice-buttons {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }
        
        .same-btn {
            background-color: #4CAF50 !important;
            color: white !important;
            padding: 14px 36px !important;
            font-size: 20px !important;
            font-weight: bold !important;
            border: none !important;
            border-radius: 10px !important;
            min-width: 150px !important;
        }
        
        .same-btn:hover {
            background-color: #45a049 !important;
        }
        
        .different-btn {
            background-color: #f44336 !important;
            color: white !important;
            padding: 14px 36px !important;
            font-size: 20px !important;
            font-weight: bold !important;
            border: none !important;
            border-radius: 10px !important;
            min-width: 150px !important;
        }
        
        .different-btn:hover {
            background-color: #da190b !important;
        }
        
        .feedback-correct {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
        }
        
        .feedback-incorrect {
            color: #f44336;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body></body>

<script>
    // Initialize jsPsych
    const jsPsych = initJsPsych({
        on_finish: function() {
            jsPsych.data.displayData();
        }
    });
    
    // Generate subject ID and filename
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;
    
    // Add subject ID to all data
    jsPsych.data.addProperties({
        subject_id: subject_id
    });
    
    // Consent form
    const consent = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <h1>Research Study Consent Form</h1>
            <div class="consent-content">
                <p>You are being invited to participate in a research study titled "Reproducibility of Psychological Science and Instruction." This study is being done by Dr. Bria Long from UC San Diego and associated graduate students in Experimental Methods course. You were selected to participate in this study because you are an adult in the U.S. and have been a represented population in previous psychology studies.</p>
                
                <p>The purpose of this study is to better understand how well previously published studies in the psychological field replicate online and with different populations. Your participation in this research should last approximately 5-30 minutes. If you agree to take part in this study, you may be asked to view a set of stimuli, including pictures, sounds, written text, or videos and then giving some responses via key-presses, verbally, or with paper-and-pencil. We may also observe your choices or preferences among an array of stimuli. These stimuli will be taken directly from or closely adapted from studies that already exist in the published psychological literature. Stimuli will include, e.g., pictures of objects and human faces, audio and video clips, short text passages, etc. None of the stimuli will be disturbing, threatening, or offensive. The online and in-person experiments described in this protocol will take no more than 30 minutes. An example game you might play would be to click on an image on the screen that matches a word you hear being said out loud. Your total expected time commitment for this study is between 5-30 minutes, and is specified in the study description.</p>
                
                <p>Your participation in this study is completely voluntary and you can withdraw at any time. Choosing not to participate or withdrawing will result in no penalty or loss of benefits to which you are entitled. You are free to skip any question that you choose.</p>
                
                <p>We will not be asking for any personally identifying information, and we will handle responses as confidentially as possible. Your SONA or Prolific IDs will never be tied to your responses on this survey. However, we cannot guarantee the confidentiality of information transmitted over the Internet. To minimize this risk, data containing anything that might be personally identifiable (e.g. Prolific IDs or IP addresses) will be encrypted on transfer and storage and will only be accessible to qualified lab personnel. We will be keeping data collected as part of this experiment indefinitely. This anonymized data (containing neither Prolific IDs nor IP addresses) may be shared with the scientific community or with other participants to be used as stimuli in future studies.</p>
                
                <p>If you have questions about this project or if you have a research-related problem, you may contact the researcher(s), Dr. Bria Long, <a href="mailto:brlong@ucsd.edu">brlong@ucsd.edu</a>. If you have any questions concerning your rights as a research subject, you may contact the UC San Diego Office of IRB Administration at <a href="mailto:irb@ucsd.edu">irb@ucsd.edu</a> or 858-246-4777.</p>
                
                <p><strong>By participating in this research you are indicating that you are at least 18 years old, have read this consent form, and agree to participate in this research study. Please keep this consent form for your records.</strong></p>
            </div>
            
            <div class="consent-checkboxes">
                <h3>Please confirm:</h3>
                <label>
                    <input type="checkbox" id="consent-age" required>
                    I am 18 years of age or older
                </label>
                <label>
                    <input type="checkbox" id="consent-understand" required>
                    I have read and understand the study procedures
                </label>
                <label>
                    <input type="checkbox" id="consent-voluntary" required>
                    I understand participation is voluntary and I can withdraw at any time
                </label>
            </div>
        `,
        choices: ['I Consent - Begin Study'],
        button_html: '<button class="jspsych-btn">%choice%</button>',
        on_load: function() {
            // Store references to checkboxes that we can access later
            const ageBox = document.getElementById('consent-age');
            const understandBox = document.getElementById('consent-understand');
            const voluntaryBox = document.getElementById('consent-voluntary');
            
            // Store the state in a variable accessible to on_finish
            this.consentState = {
                age: false,
                understand: false,
                voluntary: false
            };
            
            // Update state when checkboxes change
            const self = this;
            ageBox.addEventListener('change', function() {
                self.consentState.age = this.checked;
            });
            understandBox.addEventListener('change', function() {
                self.consentState.understand = this.checked;
            });
            voluntaryBox.addEventListener('change', function() {
                self.consentState.voluntary = this.checked;
            });
        },
        on_finish: function(data) {
            // Use the stored state instead of trying to access DOM elements
            const state = this.consentState || {age: false, understand: false, voluntary: false};
            
            data.consent_age = state.age;
            data.consent_understand = state.understand;
            data.consent_voluntary = state.voluntary;
            data.consent_valid = state.age && state.understand && state.voluntary;
        }
    };
    
    // Instructions
    const instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <h1>Instructions</h1>
            <p>In this task, you will see two pictures of faces side-by-side.</p>
            <p>You will have to decide whether the top parts, the yellow parts of the faces are the same or different.</p>
            <p>To answer, click on either the "SAME" or "DIFFERENT" buttons below the images.</p>
            <p>Try to answer as quickly as you can.</p>
            <p>There will be practice trials. Once you click on "Next" after the second practice, the experiment will automatically start.</p>
        `,
        choices: ["Let's Practice!"],
        button_html: '<button class="jspsych-btn">%choice%</button>'
    };
    
    // Enter fullscreen
    const enter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true
    };
    
    // Helper function to create trial stimulus HTML
    function createTrialStimulus(imageLeft, imageRight, trialNum, totalTrials, isPractice) {
        const progressText = isPractice ? 
            `Practice Trial ${trialNum} of ${totalTrials}` :
            `Trial ${trialNum} of ${totalTrials}`;
            
        return `
            <div style="text-align: center;">
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">${progressText}</p>
                <div class="face-images">
                    <img src="${imageLeft}" alt="Face 1">
                    <img src="${imageRight}" alt="Face 2">
                </div>
                <h2 class="trial-question">Are the top parts of the faces, the yellow parts, the same or different?</h2>
            </div>
        `;
    }
    
    // Practice trials
    const practiceBaseUrl = 'https://raw.githubusercontent.com/annapusok731/lookit-stimuli-template/master/';
    
    const practiceTrials = [
        {
            images: [
                practiceBaseUrl + 'test_stimuli/william_arnold.jpg',
                practiceBaseUrl + 'test_stimuli/arnold_william.jpg'
            ],
            correctAnswer: 'different'
        },
        {
            images: [
                practiceBaseUrl + 'test_stimuli/bridget_bridget.jpg',
                practiceBaseUrl + 'test_stimuli/bridget_alexis.jpg'
            ],
            correctAnswer: 'same'
        }
    ];
    
    // Create practice trial procedures
    const practiceProcedures = [];
    
    practiceTrials.forEach((trial, index) => {
        // Randomize left/right
        const images = Math.random() < 0.5 ? trial.images : [trial.images[1], trial.images[0]];
        
        const practiceTrial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: createTrialStimulus(images[0], images[1], index + 1, practiceTrials.length, true),
            choices: ['SAME', 'DIFFERENT'],
            button_html: ['<button class="jspsych-btn same-btn">%choice%</button>', '<button class="jspsych-btn different-btn">%choice%</button>'],
            data: {
                task: 'practice',
                trial_number: index + 1,
                correct_answer: trial.correctAnswer,
                image_left: images[0],
                image_right: images[1]
            },
            on_finish: function(data) {
                data.response_label = data.response === 0 ? 'same' : 'different';
                data.correct = data.response_label === data.correct_answer;
            }
        };
        
        const feedback = {
            type: jsPsychHtmlButtonResponse,
            stimulus: function() {
                const lastTrial = jsPsych.data.get().last(1).values()[0];
                if (lastTrial.correct) {
                    return `
                        <h1 class="feedback-correct">Great job!</h1>
                        <p style="font-size: 18px; margin-top: 20px;">The top parts of the faces are ${lastTrial.correct_answer}!</p>
                    `;
                } else {
                    return `
                        <h1 class="feedback-incorrect">Try again!</h1>
                        <p style="font-size: 18px; margin-top: 20px;">The top parts of the faces are ${lastTrial.correct_answer}. Let's try another practice.</p>
                    `;
                }
            },
            choices: ['Next'],
            button_html: '<button class="jspsych-btn">%choice%</button>'
        };
        
        practiceProcedures.push(practiceTrial, feedback);
    });
    
    // Add transition message after practice
    const practiceComplete = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <h1 class="feedback-correct">Practice Complete!</h1>
            <p style="font-size: 18px; margin-top: 20px;">Great job! Now starting the main experiment.</p>
        `,
        choices: ['Continue'],
        button_html: '<button class="jspsych-btn">%choice%</button>'
    };
    
    // Generate main trials
    function generateTrials() {
        const baseUrl = 'https://raw.githubusercontent.com/annapusok731/composite_face_effect_studies/main/CFE_Adult/';
        
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        function getStimNames(names, conditions) {
            const leftRightStim = [];
            for (let i = 0; i < names.length; i++) {
                const cond = conditions[i];
                const name = names[i].split("_");
                const image1 = name[0];
                const image2 = name[1];
                
                if (cond === 'diff_align') {
                    leftRightStim.push({
                        images: [
                            baseUrl + 'misaligned/' + image1 + '_' + image2 + '.jpg',
                            baseUrl + 'misaligned/' + image2 + '_' + image1 + '.jpg'
                        ],
                        condition: 'diff_align',
                        correctAnswer: 'different'
                    });
                } else if (cond === 'diff_misalign') {
                    leftRightStim.push({
                        images: [
                            baseUrl + 'aligned/' + image1 + '_' + image2 + '.jpg',
                            baseUrl + 'aligned/' + image2 + '_' + image1 + '.jpg'
                        ],
                        condition: 'diff_misalign',
                        correctAnswer: 'different'
                    });
                } else if (cond === 'same') {
                    const x = Math.random() < 0.5;
                    if (x) {
                        leftRightStim.push({
                            images: [
                                baseUrl + 'aligned/' + image1 + '_' + image2 + '.jpg',
                                baseUrl + 'aligned/' + image1 + '_' + image1 + '.jpg'
                            ],
                            condition: 'same_aligned',
                            correctAnswer: 'same'
                        });
                        leftRightStim.push({
                            images: [
                                baseUrl + 'misaligned/' + image2 + '_' + image2 + '.jpg',
                                baseUrl + 'misaligned/' + image2 + '_' + image1 + '.jpg'
                            ],
                            condition: 'same_misaligned',
                            correctAnswer: 'same'
                        });
                    } else {
                        leftRightStim.push({
                            images: [
                                baseUrl + 'aligned/' + image2 + '_' + image2 + '.jpg',
                                baseUrl + 'aligned/' + image2 + '_' + image1 + '.jpg'
                            ],
                            condition: 'same_aligned',
                            correctAnswer: 'same'
                        });
                        leftRightStim.push({
                            images: [
                                baseUrl + 'misaligned/' + image1 + '_' + image2 + '.jpg',
                                baseUrl + 'misaligned/' + image1 + '_' + image1 + '.jpg'
                            ],
                            condition: 'same_misaligned',
                            correctAnswer: 'same'
                        });
                    }
                }
            }
            return leftRightStim;
        }
        
        const conditions = ["same", "same", "same", "same", "same", "same", 
                          "diff_align", "diff_align", "diff_align", 
                          "diff_misalign", "diff_misalign", "diff_misalign"];
        const females = ["emma_lili", "beth_zoe", "grace_hanna", "vanessa_sara", 
                       "liv_rose", "tammy_daisy", "tess_mary", "mimi_kelly", 
                       "dolly_laura", "amber_jess", "isabel_nora", "lisa_paige"];
        const males = ["carter_liam", "mike_jason", "rick_alex", "james_ted", 
                     "bob_andy", "steven_conrad", "owen_tom", "will_dan", 
                     "cody_zack", "leo_oliver", "wane_john", "david_luca"];
        
        const allFaces = females.concat(males);
        let trials = [];
        
        // Generate trials 3 times
        for (let rep = 0; rep < 3; rep++) {
            const shuffledConditions = shuffle([...conditions]);
            const allConditions = shuffledConditions.concat(shuffle([...conditions]));
            const newTrials = getStimNames(allFaces, allConditions);
            trials = trials.concat(newTrials);
        }
        
        // Shuffle and take first 96 trials
        trials = shuffle(trials).slice(0, 96);
        
        // Randomize left/right and add trial numbers
        return trials.map((trial, index) => {
            const images = Math.random() < 0.5 ? trial.images : [trial.images[1], trial.images[0]];
            return {
                type: jsPsychHtmlButtonResponse,
                stimulus: createTrialStimulus(images[0], images[1], index + 1, 96, false),
                choices: ['SAME', 'DIFFERENT'],
                button_html: ['<button class="jspsych-btn same-btn">%choice%</button>', '<button class="jspsych-btn different-btn">%choice%</button>'],
                data: {
                    task: 'main',
                    trial_number: index + 1,
                    condition: trial.condition,
                    correct_answer: trial.correctAnswer,
                    image_left: images[0],
                    image_right: images[1]
                },
                on_finish: function(data) {
                    data.response_label = data.response === 0 ? 'same' : 'different';
                    data.correct = data.response_label === data.correct_answer;
                }
            };
        });
    }
    
    const mainTrials = generateTrials();
    
    // Preload all images
    function getAllImageUrls() {
        const urls = [];
        
        // Practice images
        practiceTrials.forEach(trial => {
            urls.push(...trial.images);
        });
        
        // Main trial images
        mainTrials.forEach(trial => {
            urls.push(trial.data.image_left, trial.data.image_right);
        });
        
        return urls;
    }
    
    const preload = {
        type: jsPsychPreload,
        images: getAllImageUrls(),
        message: 'Loading images... Please wait.',
        show_progress_bar: true
    };
    
    // SRS Questionnaire
    const srsQuestions = [
        "I am much more uncomfortable in social situations than when I am by myself.",
        "My facial expressions send the wrong message to others about how I actually feel.",
        "I feel self-confident when interacting with others.",
        "When under stress, he or she shows rigid or inflexible patterns of behaviors that seem odd.",
        "I do not recognize when others are trying to take advantage of me.",
        "I would rather be alone than with others.",
        "I am usually aware of how others are feeling.",
        "I behave in ways that seem strange or bizarre to others.",
        "I am overly dependent on others for help with meeting my everyday needs.",
        "I take things too literally, and because of that, I misinterpret the intended meaning of parts of a conversation.",
        "I have good self-confidence.",
        "I am able to communicate my feelings to others.",
        "I am awkward in turn-taking interactions with others (for example, I have a hard time keeping up with the give-and-take of a conversation).",
        "I am not well coordinated.",
        "When people change their tone or facial expression, I usually pick up on that and understand what it means.",
        "I avoid eye contact or am told that I have unusual eye contact.",
        "I recognize when something is unfair.",
        "I have difficulty making friends, even when trying my best.",
        "I get frustrated trying to get ideas across in conversations.",
        "I have sensory interests that others find unusual (for example, smelling or looking at things in a special way).",
        "I am able to imitate others' actions and expressions when it is socially appropriate to do so.",
        "I interact appropriately with other adults.",
        "I do not join group activities or social events unless prompted or strongly urged to do so.",
        "I have more difficulty than others with changes in my routine.",
        "I do not mind going out of step with or 'not on the same wavelength' as others.",
        "I offer comfort to others when they are sad.",
        "I avoid starting social interactions with other adults.",
        "I think or talk about the same thing over and over.",
        "I am regarded by others as odd or weird.",
        "I become upset in situations with lots of things going on.",
        "I can't get my mind off something once I start thinking about it.",
        "I have good personal hygiene.",
        "My behavior is socially awkward, even when I am trying to be polite.",
        "I avoid people who want to be emotionally close to me.",
        "I have trouble keeping up with the flow of a normal conversation.",
        "I have difficulty relating to family members.",
        "I have difficulty relating to adults outside of my family.",
        "I respond appropriately to mood changes in others (for example, when a friend's mood changes from happy to sad).",
        "People think I am interested in too few topics, or that I get too carried away with those topics.",
        "I am imaginative.",
        "I sometimes seem to wander aimlessly from one activity to another.",
        "I am overly sensitive to certain sounds, textures, or smells.",
        "I enjoy small talk (casual conversation with others).",
        "I have more trouble than most people with understanding chains of causation (in other words, how events are related to one another).",
        "When others around me are paying attention to something, I get interested in what they are attending to.",
        "Others feel that I have overly serious facial expressions.",
        "I laugh at inappropriate times.",
        "I have a good sense of humor and can understand jokes.",
        "I do extremely well at certain kinds of intellectual tasks, but do not do as well at most other tasks.",
        "I have repetitive behaviors that others consider odd.",
        "I have difficulty answering questions directly and end up talking around the subject.",
        "I get overly loud without realizing it.",
        "I tend to talk in a monotone voice (in other words, less inflection of voice than most people demonstrate).",
        "I tend to think about people in the same way that I do objects.",
        "I get too close to others or invade their personal space without realizing it.",
        "I sometimes make the mistake of walking between two people who are trying to talk to one another.",
        "I tend to stare at myself.",
        "I concentrate too much on parts of things rather than seeing the whole picture.",
        "I am more suspicious than most people.",
        "Other people think I am emotionally distant and do not show my feelings.",
        "I tend to be inflexible.",
        "When I tell someone my reason for doing something, it strikes the person as unusual or illogical.",
        "My way of greeting another person is unusual.",
        "I am much more tense in social settings than when I am by myself.",
        "I find myself staring or gazing off into space."
    ];
    
    const questionnaire = {
        type: jsPsychSurveyMultiChoice,
        preamble: '<h1>Social Questionnaire</h1><p>Please answer the following questions!</p>',
        questions: srsQuestions.map((q, i) => ({
            prompt: `${i + 1}. ${q}`,
            name: `Q${i + 1}`,
            options: ["Not True", "Sometimes True", "Often True", "Almost Always True"],
            required: true
        })),
        button_label: 'Submit Questionnaire'
    };
    
    // Exit fullscreen
    const exit_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: false
    };
    
    // Save data using DataPipe
    const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "m0aYmPWH3K7B",
        filename: filename,
        data_string: () => jsPsych.data.get().csv()
    };
    
    // Completion screen
    const completion = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <h1>Study Complete!</h1>
            <p>Thank you for participating in this study.</p>
            
            <h2>What Are We Studying?</h2>
            <p>Thank you for participating in the study! In this experiment, we were looking at how people perceive faces. 
                Specifically, we used a task called the composite face effect. In this task, we showed you faces that were made by combining the top half of one person's face with the bottom half of another person's face.
                The idea behind this is that when the halves are aligned, people tend to automatically process the face as a whole, which can make it harder to focus on just the top or bottom half. When the halves are misaligned, it's easier to see the two halves separately. 
                By comparing your responses across these conditions, we can learn about how people naturally integrate facial features and how this affects face recognition.
                We also have a study for young kids, and try to see how holistic face perception develops across all ages!
                To learn more about the lab's work, visit: https://dnlab.ucsd.edu/ or email the graduate student in charge: Anna Pusok at annapusok@ucsd.edu
            </p>
        `,
        choices: ['Close Window'],
        button_html: '<button class="jspsych-btn">%choice%</button>',
        on_finish: function() {
            window.close();
        }
    };
    
    // Create timeline
    const timeline = [
        consent,
        instructions,
        preload,
        enter_fullscreen,
        ...practiceProcedures,
        practiceComplete,
        ...mainTrials,
        questionnaire,
        exit_fullscreen,
        save_data,
        completion
    ];
    
    // Run experiment
    jsPsych.run(timeline);
</script>
</html>